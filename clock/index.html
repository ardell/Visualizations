<html>
    
<head>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.js"></script>
  <script type="text/javascript" src="http://cloud.github.com/downloads/processing-js/processing-js/processing-1.3.6.js"></script>
  <script type="text/javascript" src="https://raw.github.com/jeresig/jquery.hotkeys/master/jquery.hotkeys.js"></script>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
  <script type="text/javascript" src="recorder.js"></script>
  <style type="text/css">
    html, body, canvas {
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
<div id="microphone"></div>
<canvas id="canvas1"></canvas>
<script type="text/javascript">
var processingInstance;
var pluginData = (function() {
  var obj = {
    defaults: {
      background: { red: 255, green: 0, blue: 0 },
      size:       50,
    },
    data: {
    }
  };

  // Public API
  obj.background = function(newBackground) {
    if (!obj.data.background) obj.data.background = obj.defaults.background;
    if (newBackground) obj.data.background = newBackground;
    return obj.data.background;
  };
  obj.size = function(newSize) {
    if (!obj.data.size) obj.data.size = obj.defaults.size;
    if (newSize) {
        // Dampen size by only allowing you to change it 1px at a time
        obj.data.size = Math.max(obj.data.size - 10, newSize);
        console.log(obj.data.size);
    }
    return obj.data.size;
  };
  obj.toggleBackground = function() {
    if (
      obj.background().red   == obj.defaults.background.red   &&
      obj.background().green == obj.defaults.background.green &&
      obj.background().blue  == obj.defaults.background.blue
    )
    {
      obj.background({ red: 0, green: 255, blue: 0 });
    } else {
      obj.background(obj.defaults.background);
    }
  };

  return obj;
}());

$(document).ready(function() {
  $(window).resize(handleResize);
  Wami.setup('microphone');
  setUpProcessing();
  handleResize();
  $(document).bind('keydown', 'b', pluginData.toggleBackground);
});

function handleResize()
{
  var width             = $(window).width();
  var height            = $(window).height();
  var canvas            = $('#canvas1');
  var context           = canvas[0].getContext('2d');
  context.canvas.width  = width;
  context.canvas.height = height;
  if (processingInstance) processingInstance.size(width, height);
}

function setUpProcessing()
{
  // attaching the sketchProc function to the canvas
  var canvas         = $('#canvas1')[0];
  processingInstance = new Processing(canvas, draw);
}

function draw(processing) {
  var isRecording = false;
  processing.draw = function() {
    // determine center and max clock arm length
    var centerX = processing.width / 2, centerY = processing.height / 2;
    var maxArmLength = Math.min(centerX, centerY);

    function drawCircle(diameter, weight) {
      processing.strokeWeight(weight);
      processing.ellipse(centerX, centerY, diameter, diameter);
    }

    // Set wami recording if he isn't already
    if (!isRecording && Wami && Wami.startRecording)
    {
        Wami.startRecording('http://127.0.0.1');
        isRecording = true;
    }

    // erase background
    processing.background(0);

    // Draw a circle
    var micLevel = (Wami && Wami.getRecordingLevel) ? Wami.getRecordingLevel() : 0;
    var diameter = pluginData.size(Math.max(50, Math.min(300, 20 * micLevel)));
    drawCircle(diameter, 5);
  };
}
</script>
</body>

</html>
